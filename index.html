<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HealingLensStudio Calm</title>

  <!-- Manifest for PWA support -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="HealingLensStudio Calm">
  <link rel="apple-touch-icon" href="logo.png">

  <style>
    body {
      margin: 0;
      font-family: 'Libre Baskerville', serif;
      background: linear-gradient(135deg, #f5f1ec, #e6f0ec, #fdfcfa);
      color: #2E2E2E;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }

    .logo img {
      width: 120px;
      margin: 15px auto;
      display: block;
    }

    h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    h2 {
      font-family: 'Libre Baskerville', serif;
      font-size: 1rem;
      font-style: italic;
      margin-bottom: 10px;
    }

    .app-description {
      font-family: 'Libre Baskerville', serif;
      font-size: 1rem;
      color: #555;
      max-width: 700px;
      margin: 10px auto 20px auto;
      line-height: 1.6;
    }

    .prompt-box {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      max-width: 500px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      text-align: left;
      white-space: pre-wrap;
    }

    .prompt {
      font-size: 1.1rem;
      line-height: 1.6;
      margin: 0;
    }

    .controls {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-bottom: 10px;
    }

    button, select {
      min-height: 44px;
      margin: 8px;
      padding: 10px 18px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    button {
      background: #EED9D0;
      color: #2E2E2E;
      transition: background 0.3s;
    }

    button:hover, button:focus {
      background: #D5E0D5;
      outline: none;
    }

    .favorites {
      margin-top: 10px;
      max-width: 500px;
      text-align: left;
      display: none;
    }

    .favorites ul { padding-left: 16px; }

    .breathe-circle {
      width: 120px; height: 120px;
      margin: 20px auto;
      border-radius: 50%;
      background: #EED9D0;
      display: none;
    }

    .footer {
      font-size: 0.8rem;
      margin-top: 20px;
      font-style: italic;
    }

    @media (max-width: 600px) {
      h1 { font-size: 1.4rem; }
      .prompt { font-size: 1rem; }
      button, select { font-size: 0.9rem; padding: 10px; }
    }

    /* simple toast */
    #toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      display: none;
      z-index: 9999;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="logo" aria-hidden="true">
    <picture>
      <source srcset="logo.webp" type="image/webp">
      <img src="logo.png" alt="HealingLensStudio Logo">
    </picture>
  </div>

  <h1>HealingLensStudio Calm</h1>
  <h2>For the Quiet in You üåø</h2>
  <p class="app-description">
    A gentle digital calm corner ‚Äî with daily prompts, affirmations, and soft practices 
    for your nervous system.<br>
    Free. Always here. For the quiet in you.
  </p>

  <div class="controls" role="group" aria-label="Mode and category">
    <label><input type="radio" name="mode" value="prompt" checked> Prompts</label>
    <label><input type="radio" name="mode" value="affirmation"> Affirmations</label>

    <select id="category" aria-label="Choose category">
      <option value="mindfulness">üåø Mindfulness</option>
      <option value="movement">‚ú® Movement</option>
      <option value="kindness">üíõ Kindness</option>
      <option value="creativity">üé® Creativity</option>
    </select>
  </div>

  <div class="prompt-box" id="promptArea">
    <p id="prompt" class="prompt">‚ú® Loading your calm‚Ä¶</p>
  </div>

  <div class="controls" aria-hidden="false">
    <button id="newBtn">üå∏ New</button>
    <button id="copyBtn">üìã Copy</button>
    <button id="shareBtn">üì§ Share</button>
    <button id="favBtn">‚≠ê Favorite</button>
    <button id="toggleFavBtn">üìñ Favorites</button>
  </div>

  <div class="favorites" id="favorites"></div>

  <h3>Breathe With Me</h3>
  <div class="breathe-circle" id="breathe-circle" aria-hidden="true"></div>
  <div class="controls">
    <button id="startBreath">‚ñ∂ Start</button>
    <button id="stopBreath">‚ñ† Stop</button>
  </div>

  <div class="footer">HealingLensStudio | For the Quiet in You</div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // -- Data will be loaded from prompts.json
    let prompts = {};
    let affirmations = {};

    async function loadLibrary() {
      try {
        const res = await fetch('./prompts.json', { cache: "no-store" });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const lib = await res.json();

        if (lib && lib.prompts && lib.affirmations) {
          prompts = lib.prompts;
          affirmations = lib.affirmations;
          console.log('Library loaded');
          newPrompt();
          return;
        }
      } catch (e) {
        console.warn('Could not load prompts.json ‚Äî check path or file', e);
        document.getElementById("prompt").innerText = "‚ú® Could not load prompts. Please check prompts.json.";
      }
    }

    const lastPromptByCategory = {};
    let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

    function newPrompt() {
      const category = document.getElementById("category").value;
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const set = (mode === "prompt" ? prompts : affirmations)[category];

      if (!set || !set.length) {
        document.getElementById("prompt").innerText = "No items available for this category. Please check prompts.json.";
        return;
      }

      let randomIndex;
      do {
        randomIndex = Math.floor(Math.random() * set.length);
      } while (randomIndex === lastPromptByCategory[category] && set.length > 1);
      lastPromptByCategory[category] = randomIndex;
      const text = set[randomIndex];
      document.getElementById("prompt").innerText = text + (mode === "prompt" ? "\n\nüåø Breathe this in. Try writing one line in your journal." : "");
    }

    async function copyPrompt() {
      const text = document.getElementById("prompt").innerText;
      try {
        await navigator.clipboard.writeText(text);
        showToast('Copied!');
      } catch (e) {
        showToast('Copy failed');
      }
    }

    async function sharePrompt() {
      const text = document.getElementById("prompt").innerText;
      if (navigator.share) {
        try {
          await navigator.share({ title: "HealingLensStudio Calm", text });
        } catch {}
      } else {
        await navigator.clipboard.writeText(text);
        showToast("Copied instead (share not supported)");
      }
    }

    function addFavorite() {
      const text = document.getElementById("prompt").innerText;
      if (!text) return;
      if (!favorites.includes(text)) {
        favorites.push(text);
        localStorage.setItem("favorites", JSON.stringify(favorites));
        showToast('‚≠ê Saved to favorites!');
      } else {
        showToast('Already saved');
      }
    }

    function toggleFavorites() {
      const container = document.getElementById("favorites");
      if (container.style.display === "none" || !container.style.display) {
        renderFavorites();
        container.style.display = "block";
      } else {
        container.style.display = "none";
      }
    }

    function renderFavorites() {
      const container = document.getElementById("favorites");
      if (!favorites.length) {
        container.innerHTML = "<h4>Your Favorites:</h4><ul><li>No favorites yet.</li></ul>";
        return;
      }
      const list = favorites.map((f, i) => `
        <li style="margin-bottom:8px;">
          <div style="white-space:pre-wrap;">${escapeHtml(f)}</div>
          <button onclick="useFavorite(${i})">Use</button>
          <button onclick="removeFavorite(${i})">Remove</button>
        </li>`).join("");
      container.innerHTML = `<h4>Your Favorites:</h4><ul>${list}</ul>`;
    }

    function useFavorite(i) {
      document.getElementById("prompt").innerText = favorites[i];
    }

    function removeFavorite(i) {
      favorites.splice(i, 1);
      localStorage.setItem("favorites", JSON.stringify(favorites));
      renderFavorites();
    }

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Breathing
    let breathAnim = null;
    function startBreathing() {
      const circle = document.getElementById("breathe-circle");
      circle.style.display = "block";
      if (breathAnim) breathAnim.cancel();
      breathAnim = circle.animate([
        { transform: "scale(1)", background: "#EED9D0" },
        { transform: "scale(1.6)", background: "#D5E0D5" },
        { transform: "scale(1)", background: "#EED9D0" }
      ], {
        duration: 8000,
        iterations: Infinity,
        easing: "ease-in-out"
      });
    }
    function stopBreathing() {
      const circle = document.getElementById("breathe-circle");
      if (breathAnim) breathAnim.cancel();
      circle.style.display = "none";
    }

    function showToast(msg, ms = 1500) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => { t.style.display = "none"; }, ms);
    }

    // Event bindings
    document.getElementById("newBtn").addEventListener("click", newPrompt);
    document.getElementById("copyBtn").addEventListener("click", copyPrompt);
    document.getElementById("shareBtn").addEventListener("click", sharePrompt);
    document.getElementById("favBtn").addEventListener("click", addFavorite);
    document.getElementById("toggleFavBtn").addEventListener("click", toggleFavorites);
    document.getElementById("startBreath").addEventListener("click", startBreathing);
    document.getElementById("stopBreath").addEventListener("click", stopBreathing);
    document.getElementById("category").addEventListener("change", newPrompt);
    document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", newPrompt));

    window.onload = () => { loadLibrary(); };
  </script>
</body>
</html>
