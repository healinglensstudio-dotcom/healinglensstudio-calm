<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HealingLensStudio Calm</title>
  <style>
    :root{
      --bg1:#f5f1ec; --bg2:#e6f0ec; --text:#2E2E2E; --card:#fff;
      --accent:#EED9D0; --accent2:#D5E0D5; --muted:#6b6b6b;
    }
    html,body{height:100%;margin:0}
    body{
      font-family:'Libre Baskerville',serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--text);
      padding:20px; display:flex; flex-direction:column; align-items:center; text-align:center;
    }
    h1{ font-family:'Poppins',sans-serif; font-size:1.8rem; margin:8px 0 2px; }
    h2{ font-style:italic; color:var(--muted); margin:0 0 12px; }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:12px 0; align-items:center;}
    .prompt-box{ background:var(--card); border-radius:12px; padding:18px; width:100%; max-width:760px; box-shadow:0 10px 26px rgba(0,0,0,0.06); text-align:left; white-space:pre-wrap; margin-bottom:12px;}
    .prompt{ font-size:1.15rem; line-height:1.6; margin:0; }
    button{ background:var(--accent); border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-family:'Poppins',sans-serif; }
    button.secondary{ background:transparent; border:1px solid rgba(0,0,0,0.06); }
    select{ padding:8px 12px; border-radius:8px; }
    .breathe-circle{ width:120px; height:120px; border-radius:50%; background:var(--accent); margin:18px auto; display:none; opacity:0; box-shadow:0 12px 30px rgba(0,0,0,0.06); transform-origin:center; }
    @keyframes breathe-css{ 0%{transform:scale(1);background:var(--accent);}50%{transform:scale(1.6);background:var(--accent2);}100%{transform:scale(1);background:var(--accent);} }
    .breathe-css{ animation:breathe-css 6000ms ease-in-out 4 forwards; opacity:1 !important; }
    .fav-panel{ width:100%; max-width:760px; margin-top:12px; text-align:left; display:none; }
    .fav-card{ background:var(--card); padding:12px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.06); }
    .fav-item{ margin-bottom:12px; white-space:pre-wrap; }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:rgba(0,0,0,0.85); color:#fff; padding:8px 12px; border-radius:8px; display:none; z-index:9999; }
    .footer{ font-size:0.9rem; margin-top:18px; color:var(--muted); font-style:italic; }
    @media(max-width:600px){ .prompt{ font-size:1.02rem;} button, select{ min-width:42vw; } .breathe-circle{ width:100px; height:100px; } }
  </style>
</head>
<body>
  <h1>HealingLensStudio Calm</h1>
  <h2>For the Quiet in You üåø</h2>

  <div class="controls" role="group" aria-label="Mode and category">
    <label><input type="radio" name="mode" value="prompt" checked> Prompts</label>
    <label><input type="radio" name="mode" value="affirmation"> Affirmations</label>
    <select id="category" aria-label="Choose category">
      <option value="mindfulness">üåø Mindfulness</option>
      <option value="movement">‚ú® Movement</option>
      <option value="kindness">üíõ Kindness</option>
      <option value="creativity">üé® Creativity</option>
    </select>
  </div>

  <div class="prompt-box"><p id="prompt" class="prompt">‚ú® Loading your calm‚Ä¶</p></div>

  <div class="controls">
    <button id="newBtn">üå∏ New</button>
    <button id="copyBtn" class="secondary">üìã Copy</button>
    <button id="shareBtn">üì§ Share</button>
    <!-- Single Favorites button -->
    <button id="favToggleBtn" class="secondary">üìö Favorites</button>
  </div>

  <!-- Collapsible favorites panel; panel includes Save current -->
  <div class="fav-panel" id="favPanel" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div style="display:flex;gap:8px;align-items:center;">
        <strong>Favorites</strong>
        <button id="saveCurrentBtn" class="secondary" style="padding:6px 10px;">‚≠ê Save current</button>
      </div>
      <div style="display:flex;gap:8px;">
        <button id="clearFavBtn" class="secondary">Clear all</button>
        <button id="closeFavBtn" class="secondary">Close</button>
      </div>
    </div>
    <div class="fav-card" id="favList">No favorites yet.</div>
  </div>

  <h3>Breathe With Me</h3>
  <div id="breatheCircle" class="breathe-circle" aria-hidden="true"></div>
  <div style="margin:10px 0; display:flex; gap:8px; justify-content:center;">
    <button id="startBtn">‚ñ∂ Start</button>
    <button id="stopBtn" class="secondary">‚ñ† Stop</button>
  </div>

  <div class="footer">HealingLensStudio | For the Quiet in You</div>
  <div id="toast" role="status" aria-live="polite"></div>

<script>
/* ---------- Library loader (prompts.json if present) ---------- */
/* Minimal fallback used only if prompts.json fails to load */
const FALLBACK = {
  prompts: {
    mindfulness:[ "Pause. Place one hand on your chest. Feel one full breath enter and leave.", "Notice one sound around you that feels calming. Stay with it for one minute.", "Close your eyes and imagine your favorite place in nature for 30 seconds." ],
    movement: [ "Stretch your arms overhead like you‚Äôre greeting the sun.", "Roll your shoulders back three times.", "Sway gently side to side like tall grass." ],
    kindness: [ "Whisper to yourself: 'I am enough.'", "Forgive yourself for something small today.", "Whisper your name with kindness." ],
    creativity: [ "Write a one-line poem about the sky.", "Sketch something near you without judgment.", "Doodle for 2 minutes with no rules." ]
  },
  affirmations: {
    mindfulness:[ "I can return to my breath anytime.","This moment is enough.","Calm is within me." ],
    movement:[ "My body deserves gentle movement.","I release tension step by step.","I honor my body's needs." ],
    kindness:[ "I am worthy of love exactly as I am.","Softness is strength.","I speak kindly to myself." ],
    creativity:[ "Expression is healing.","My ideas do not need to be perfect.","I make space for curiosity." ]
  }
};

let prompts = {}, affirmations = {};
let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');
const lastByCat = {};
let waAnim=null, fallbackTimeout=null, toastTimer=null;

// toast helper
function showToast(msg, ms=1400){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toastTimer); toastTimer=setTimeout(()=> t.style.display='none', ms); }

// load prompts.json (relative path so GH Pages subpath works)
async function loadLibrary(){
  try{
    const res = await fetch('./prompts.json', { cache: 'no-store' });
    if (res.ok){
      const lib = await res.json();
      if (lib && (lib.prompts || lib.affirmations)){
        prompts = lib.prompts || {};
        affirmations = lib.affirmations || {};
        console.log('Loaded prompts.json');
        newPrompt();
        return;
      }
    }
  } catch(e){ console.warn('Could not load prompts.json', e); }
  // fallback
  prompts = FALLBACK.prompts;
  affirmations = FALLBACK.affirmations;
  console.log('Using fallback library');
  newPrompt();
}

// prompt UI
function setPromptText(text){ document.getElementById('prompt').innerText = text; }
function newPrompt(){
  const cat = (document.getElementById('category')||{}).value || 'mindfulness';
  const mode = (document.querySelector('input[name="mode"]:checked')||{}).value || 'prompt';
  const set = (mode === 'prompt' ? prompts : affirmations)[cat] || [];
  if(!set.length){ setPromptText('No items available for this category.'); return; }
  let idx; do { idx = Math.floor(Math.random()*set.length); } while(idx === lastByCat[cat] && set.length>1);
  lastByCat[cat] = idx;
  const text = set[idx] + (mode === 'prompt' ? "\n\nüåø Breathe this in. Try writing one line in your journal." : "");
  setPromptText(text);
}

// copy & share
async function copyPrompt(){ try{ await navigator.clipboard.writeText(document.getElementById('prompt').innerText); showToast('Copied'); } catch { showToast('Copy failed'); } }
async function sharePrompt(){ const text = document.getElementById('prompt').innerText.trim(); if(!text) return showToast('Nothing to share'); if(navigator.share){ try{ await navigator.share({ title:'HealingLensStudio Calm', text }); showToast('Shared'); return; } catch{} } try{ await navigator.clipboard.writeText(text); showToast('Copied (no share)'); } catch { showToast('Could not share'); } }

// FAVORITES: single top button toggles panel. Panel contains Save current + list + actions
function toggleFavPanel(){
  const p = document.getElementById('favPanel');
  if(!p) return;
  if(p.style.display === 'block'){ p.style.display='none'; p.setAttribute('aria-hidden','true'); }
  else { renderFavorites(); p.style.display='block'; p.setAttribute('aria-hidden','false'); }
}
function saveCurrentToFavorites(){
  const text = document.getElementById('prompt').innerText;
  if(!text) return showToast('Nothing to save');
  if(!favorites.includes(text)){ favorites.push(text); localStorage.setItem('favorites', JSON.stringify(favorites)); showToast('Saved'); renderFavorites(); }
  else showToast('Already saved');
}
function renderFavorites(){
  const el = document.getElementById('favList');
  if(!favorites.length){ el.innerHTML = '<div>No favorites yet.</div>'; return; }
  el.innerHTML = favorites.map((f,i)=>`
    <div class="fav-item">
      <div>${escapeHtml(f)}</div>
      <div style="margin-top:6px; display:flex;gap:8px;">
        <button data-use="${i}" class="secondary">Use</button>
        <button data-remove="${i}" class="secondary">Remove</button>
      </div>
    </div>
  `).join('');
  el.querySelectorAll('[data-use]').forEach(b=> b.addEventListener('click', ()=>{ const i=+b.dataset.use; setPromptText(favorites[i]); showToast('Loaded'); }));
  el.querySelectorAll('[data-remove]').forEach(b=> b.addEventListener('click', ()=>{ const i=+b.dataset.remove; favorites.splice(i,1); localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavorites(); showToast('Removed'); }));
}
function clearAllFavorites(){
  if(!favorites.length) return showToast('No favorites');
  if(!confirm('Clear all favorites?')) return;
  favorites=[]; localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavorites(); showToast('Cleared');
}
function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#96;','=':'&#61;'}[c])); }

// BREATHING (WAAPI preferred, CSS fallback)
function startBreathing(){
  const el = document.getElementById('breatheCircle');
  if(!el) return;
  if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) { showToast('Reduced motion'); return; }
  el.style.display='block'; el.style.opacity='1';
  if(waAnim && waAnim.cancel) try{ waAnim.cancel(); }catch(e){}
  if(fallbackTimeout) { clearTimeout(fallbackTimeout); fallbackTimeout=null; }
  if(el.animate){
    try{
      waAnim = el.animate([
        { transform:'scale(1)', background:getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#EED9D0' },
        { transform:'scale(1.6)', background:getComputedStyle(document.documentElement).getPropertyValue('--accent2') || '#D5E0D5' },
        { transform:'scale(1)', background:getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#EED9D0' }
      ], { duration:6000, iterations:4, easing:'ease-in-out', fill:'forwards' });
      showToast('ü´Å Follow the circle to breathe');
      waAnim.onfinish = ()=>{ setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=> el.style.display='none',180); showToast('Breathing complete'); }, 60); waAnim=null; };
      return;
    }catch(e){ console.warn('WAAPI animate failed, fallback', e); }
  }
  // CSS fallback
  el.classList.remove('breathe-css'); void el.offsetWidth; el.classList.add('breathe-css'); showToast('ü´Å Follow the circle to breathe');
  fallbackTimeout = setTimeout(()=>{ el.classList.remove('breathe-css'); el.style.opacity='0'; setTimeout(()=> el.style.display='none',160); showToast('Breathing complete'); fallbackTimeout=null; }, 6000*4+80);
}
function stopBreathing(){
  const el = document.getElementById('breatheCircle');
  if(!el) return;
  if(waAnim && waAnim.cancel) try{ waAnim.cancel(); }catch(e){}
  if(fallbackTimeout){ clearTimeout(fallbackTimeout); fallbackTimeout=null; }
  el.classList.remove('breathe-css'); el.style.opacity='0'; setTimeout(()=> el.style.display='none',160);
  showToast('Stopped');
}

// wiring
window.addEventListener('load', ()=>{
  document.getElementById('newBtn').addEventListener('click', newPrompt);
  document.getElementById('copyBtn').addEventListener('click', copyPrompt);
  document.getElementById('shareBtn').addEventListener('click', sharePrompt);
  document.getElementById('favToggleBtn').addEventListener('click', toggleFavPanel);
  document.getElementById('saveCurrentBtn').addEventListener('click', saveCurrentToFavorites);
  document.getElementById('clearFavBtn').addEventListener('click', clearAllFavorites);
  document.getElementById('closeFavBtn').addEventListener('click', toggleFavPanel);
  document.getElementById('startBtn').addEventListener('click', startBreathing);
  document.getElementById('stopBtn').addEventListener('click', stopBreathing);
  document.getElementById('category').addEventListener('change', newPrompt);
  document.querySelectorAll('input[name="mode"]').forEach(r=> r.addEventListener('change', newPrompt));
  loadLibrary();
});

// expose small API for console
window.healingLens = { newPrompt, startBreathing, stopBreathing, saveCurrentToFavorites, toggleFavPanel };

</script>
</body>
</html>
