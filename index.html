<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HealingLensStudio Calm</title>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="HealingLensStudio Calm">
  <link rel="apple-touch-icon" href="logo.png">

  <style>
    :root{
      --bg:#f5f6f4; --card:#fff; --accent:#EED9D0; --accent2:#D5E0D5; --text:#2E2E2E; --muted:#6b6b6b;
    }
    html,body{height:100%;margin:0}
    body{
      font-family:'Libre Baskerville',serif;
      background:linear-gradient(135deg,#f5f1ec,#e6f0ec,#fdfcfa);
      color:var(--text); padding:20px; display:flex; flex-direction:column; align-items:center; text-align:center;
    }
    .logo img{ width:120px; display:block; margin:8px auto; }
    h1{ font-family:'Poppins',sans-serif; font-size:1.8rem; margin:6px 0 2px; }
    h2{ font-style:italic; color:var(--muted); margin:0 0 10px; }
    .app-description{ max-width:720px; color:var(--muted); margin:8px auto 14px; font-size:1rem; line-height:1.6; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; margin:12px 0; }
    .prompt-box{ background:var(--card); border-radius:12px; padding:18px; width:100%; max-width:760px; box-shadow:0 10px 26px rgba(0,0,0,0.06); text-align:left; white-space:pre-wrap; margin-bottom:12px; }
    .prompt{ font-size:1.15rem; line-height:1.6; margin:0; }

    button{ background:var(--accent); border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-family:'Poppins',sans-serif; }
    button.secondary{ background:transparent; border:1px solid rgba(0,0,0,0.06); }

    select{ padding:8px 12px; border-radius:8px; }

    /* favorites panel */
    .fav-panel{ width:100%; max-width:760px; margin-top:12px; display:none; text-align:left; }
    .fav-card{ background:var(--card); padding:12px; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,0.06); }
    .fav-item{ margin-bottom:12px; white-space:pre-wrap; }

    .breathe-circle{ width:120px; height:120px; border-radius:50%; background:var(--accent); margin:18px auto; display:none; opacity:0; box-shadow:0 12px 30px rgba(0,0,0,0.06); transform-origin:center; }
    .footer{ font-size:0.9rem; margin-top:18px; color:var(--muted); font-style:italic; }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:rgba(0,0,0,0.85); color:#fff; padding:8px 12px; border-radius:8px; display:none; z-index:9999; }

    @media(max-width:600px){ .prompt{ font-size:1.02rem; } button, select{ min-width:42vw; } .breathe-circle{ width:100px; height:100px; } }
  </style>
</head>
<body>
  <div class="logo" aria-hidden="true"><img src="logo.png" alt="HealingLensStudio logo"></div>
  <h1>HealingLensStudio Calm</h1>
  <h2>For the Quiet in You üåø</h2>

  <p class="app-description">
    A gentle digital calm corner ‚Äî with daily prompts, affirmations, and soft practices for your nervous system.<br>
    Free. Always here. For the quiet in you.
  </p>

  <div class="controls" role="group" aria-label="Mode and category">
    <label><input type="radio" name="mode" value="prompt" checked> Prompts</label>
    <label><input type="radio" name="mode" value="affirmation"> Affirmations</label>

    <select id="category" aria-label="Choose category">
      <option value="mindfulness">üåø Mindfulness</option>
      <option value="movement">‚ú® Movement</option>
      <option value="kindness">üíõ Kindness</option>
      <option value="creativity">üé® Creativity</option>
    </select>
  </div>

  <div class="prompt-box"><p id="prompt" class="prompt">‚ú® Loading your calm‚Ä¶</p></div>

  <div class="controls">
    <button id="newBtn">üå∏ New</button>
    <button id="copyBtn" class="secondary">üìã Copy</button>
    <button id="shareBtn">üì§ Share</button>
    <!-- ONLY this Favorites/top button exists -->
    <button id="toggleFavBtn" class="secondary">üìñ Favorites</button>
  </div>

  <!-- Collapsible favorites panel -->
  <div class="fav-panel" id="favPanel" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div style="display:flex;gap:8px;align-items:center;">
        <strong>Favorites</strong>
        <button id="saveCurrentBtn" class="secondary" style="padding:6px 10px;">‚≠ê Save current</button>
      </div>
      <div style="display:flex;gap:8px;">
        <button id="clearFavBtn" class="secondary">Clear all</button>
        <button id="closeFavBtn" class="secondary">Close</button>
      </div>
    </div>
    <div class="fav-card" id="favList">No favorites yet.</div>
  </div>

  <h3>Breathe With Me</h3>
  <div id="breatheCircle" class="breathe-circle" aria-hidden="true"></div>
  <div style="margin:10px 0; display:flex; gap:8px; justify-content:center;">
    <button id="startBtn">‚ñ∂ Start</button>
    <button id="stopBtn" class="secondary">‚ñ† Stop</button>
  </div>

  <div class="footer">HealingLensStudio | For the Quiet in You</div>
  <div id="toast" role="status" aria-live="polite"></div>

<script>
/* Minimal fallback library (only used if prompts.json missing) */
const FALLBACK = {
  prompts:{ mindfulness:["Pause and breathe."], movement:["Stretch gently."], kindness:["You are enough."], creativity:["Doodle for 2 minutes."] },
  affirmations:{ mindfulness:["This moment is enough."], movement:["I honor my body."], kindness:["I am worthy of kindness."], creativity:["I create freely."] }
};

let prompts = {}, affirmations = {};
let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');
let breathAnim = null, toastTimer=null;

function showToast(msg, ms=1400){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toastTimer); toastTimer=setTimeout(()=> t.style.display='none', ms); }

async function loadLibrary(){
  try{
    const res = await fetch('./prompts.json', { cache:'no-store' });
    if(res.ok){
      const lib = await res.json();
      if(lib && (lib.prompts || lib.affirmations)){
        prompts = lib.prompts || {};
        affirmations = lib.affirmations || {};
        console.log('prompts.json loaded');
        newPrompt();
        return;
      }
    }
  }catch(e){ console.warn('could not load prompts.json', e); }
  prompts = FALLBACK.prompts; affirmations = FALLBACK.affirmations; newPrompt();
}

const lastByCat = {};
function newPrompt(){
  const cat = (document.getElementById('category')||{}).value || 'mindfulness';
  const mode = (document.querySelector('input[name="mode"]:checked')||{}).value || 'prompt';
  const set = (mode==='prompt'?prompts:affirmations)[cat] || [];
  if(!set.length){ document.getElementById('prompt').innerText='No items available for this category.'; return; }
  let idx; do { idx=Math.floor(Math.random()*set.length); } while(idx===lastByCat[cat] && set.length>1);
  lastByCat[cat]=idx;
  const txt = set[idx] + (mode==='prompt' ? "\n\nüåø Breathe this in. Try writing one line in your journal." : "");
  document.getElementById('prompt').innerText = txt;
}

/* copy/share */
async function copyPrompt(){ try{ await navigator.clipboard.writeText(document.getElementById('prompt').innerText); showToast('Copied'); }catch(e){ showToast('Copy failed'); } }
async function sharePrompt(){ const t = document.getElementById('prompt').innerText.trim(); if(!t) return showToast('Nothing to share'); if(navigator.share){ try{ await navigator.share({ title:'HealingLensStudio Calm', text:t }); showToast('Shared'); return; }catch(e){} } try{ await navigator.clipboard.writeText(t); showToast('Copied (no share)'); }catch{ showToast('Share failed'); } }

/* Favorites: single panel with Save current */
function toggleFavPanel(){ const p=document.getElementById('favPanel'); if(!p) return; if(p.style.display==='block'){ p.style.display='none'; p.setAttribute('aria-hidden','true'); } else { renderFavorites(); p.style.display='block'; p.setAttribute('aria-hidden','false'); } }
function saveCurrent(){ const t=document.getElementById('prompt').innerText; if(!t) return showToast('Nothing to save'); if(!favorites.includes(t)){ favorites.push(t); localStorage.setItem('favorites', JSON.stringify(favorites)); showToast('Saved'); renderFavorites(); } else showToast('Already saved'); }
function renderFavorites(){ const el=document.getElementById('favList'); if(!favorites.length){ el.innerHTML='<div>No favorites yet.</div>'; return; } el.innerHTML = favorites.map((f,i)=>`<div class="fav-item"><div>${escapeHtml(f)}</div><div style="margin-top:6px;display:flex;gap:8px;"><button data-use="${i}" class="secondary">Use</button><button data-remove="${i}" class="secondary">Remove</button></div></div>`).join(''); el.querySelectorAll('[data-use]').forEach(b=>b.addEventListener('click',()=>{ const i=+b.dataset.use; document.getElementById('prompt').innerText = favorites[i]; showToast('Loaded'); })); el.querySelectorAll('[data-remove]').forEach(b=>b.addEventListener('click',()=>{ const i=+b.dataset.remove; favorites.splice(i,1); localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavorites(); showToast('Removed'); })); }
function clearFavs(){ if(!favorites.length) return showToast('No favorites'); if(!confirm('Clear all favorites?')) return; favorites=[]; localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavorites(); showToast('Cleared'); }
function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#96;','=':'&#61;'}[c])); }

/* breathing animation (WAAPI with safe checks) */
function startBreathing(){
  const el = document.getElementById('breatheCircle');
  if(!el) return;
  if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){ showToast('Reduced motion'); return; }
  el.style.display='block'; el.style.opacity='1';
  if(el.animate){
    try{
      if(breathAnim && breathAnim.cancel) breathAnim.cancel();
      breathAnim = el.animate([{transform:'scale(1)', background:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#EED9D0'}, {transform:'scale(1.6)', background:getComputedStyle(document.documentElement).getPropertyValue('--accent2')||'#D5E0D5'}, {transform:'scale(1)', background:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#EED9D0'}], { duration:6000, iterations:Infinity, easing:'ease-in-out' });
      showToast('ü´Å Follow the circle to breathe');
    }catch(e){ console.warn(e); el.style.display='none'; showToast('Breathing failed'); }
  } else {
    // fallback: simple CSS pulse via class (not implemented separately here)
    el.style.display='block';
    showToast('Breathing (fallback)'); // small fallback message
  }
}
function stopBreathing(){ const el=document.getElementById('breatheCircle'); if(!el) return; try{ if(breathAnim && breathAnim.cancel) breathAnim.cancel(); }catch(e){} el.style.display='none'; showToast('Stopped'); }

/* wiring */
window.addEventListener('load', ()=>{
  document.getElementById('newBtn').addEventListener('click', newPrompt);
  document.getElementById('copyBtn').addEventListener('click', copyPrompt);
  document.getElementById('shareBtn').addEventListener('click', sharePrompt);
  document.getElementById('toggleFavBtn').addEventListener('click', toggleFavPanel);
  document.getElementById('saveCurrentBtn').addEventListener('click', saveCurrent);
  document.getElementById('clearFavBtn').addEventListener('click', clearFavs);
  document.getElementById('closeFavBtn').addEventListener('click', toggleFavPanel);
  document.getElementById('startBtn').addEventListener('click', startBreathing);
  document.getElementById('stopBtn').addEventListener('click', stopBreathing);
  document.getElementById('category').addEventListener('change', newPrompt);
  document.querySelectorAll('input[name="mode"]').forEach(r=> r.addEventListener('change', newPrompt));
  loadLibrary();
});
</script>
</body>
</html>
