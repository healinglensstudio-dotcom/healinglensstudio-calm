<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HealingLensStudio Calm</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="HealingLensStudio Calm">
  <link rel="apple-touch-icon" href="logo.png">

  <style>
    :root{
      --bg-1:#f5f1ec; --bg-2:#e6f0ec; --text:#2E2E2E; --muted:#5a5a5a;
      --card:#fff; --accent:#EED9D0; --accent-2:#D5E0D5; --radius:16px;
    }
    html,body{height:100%;margin:0}
    body{
      font-family:'Libre Baskerville',serif;
      background:linear-gradient(135deg,var(--bg-1),var(--bg-2),#fdfcfa);
      color:var(--text); -webkit-font-smoothing:antialiased;
      display:flex; flex-direction:column; align-items:center; padding:22px; text-align:center;
    }

    .logo img{ width:120px; display:block; margin:10px auto; }
    h1{ font-family:'Poppins',sans-serif; font-size:1.9rem; margin:6px 0 2px; }
    h2{ font-size:1.1rem; font-style:italic; margin:0 0 10px; color:var(--muted); }
    .app-description{ max-width:680px; margin:8px auto 6px; color:var(--muted); font-size:1rem; line-height:1.6; }
    .onboard{ color:#425e4b; font-size:1rem; margin:8px auto 16px; max-width:700px; display:none; }

    .controls{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center; margin:12px 0; }
    label{ cursor:pointer; font-family:'Poppins',sans-serif; font-size:1.05rem; color:var(--text); }
    select{ border-radius:12px; padding:10px 14px; font-size:1.05rem; min-width:160px; }

    .prompt-box{
      background:var(--card); border-radius:var(--radius); box-shadow:0 8px 26px rgba(0,0,0,0.06);
      padding:20px; max-width:720px; width:100%; text-align:left; white-space:pre-wrap; margin-bottom:16px;
      transition: opacity .6s ease, transform .45s ease; opacity:1;
    }
    .prompt-box.fade-out{ opacity:0; transform:translateY(8px); }
    .prompt{ font-size:1.2rem; line-height:1.75; margin:0; color:var(--text); }

    button{ background:var(--accent); border:none; border-radius:12px; padding:10px 16px;
      font-family:'Poppins',sans-serif; font-size:1.05rem; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.03); }
    button.secondary{ background:transparent; border:1px solid rgba(0,0,0,0.06); color:var(--text); }
    button:focus{ outline:3px solid rgba(37,110,85,0.12); }

    .favorites-modal{ position:fixed; left:0; top:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:9999; }
    .favorites-backdrop{ position:absolute; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.35); backdrop-filter: blur(3px); }
    .favorites-card{ position:relative; background:var(--card); border-radius:14px; padding:18px; width:90%; max-width:620px; max-height:78vh; overflow:auto; box-shadow:0 18px 40px rgba(0,0,0,0.14); }

    .breathe-circle {
      width: 120px; height: 120px; border-radius: 50%; background: var(--accent);
      margin: 14px auto; display: none; box-shadow: 0 12px 30px rgba(0,0,0,0.06);
      z-index: 10005; transition: opacity 220ms ease; opacity: 0; transform-origin:center;
    }
    /* fallback CSS animation if needed */
    .breathe-circle.breathing { animation: breatheAnim 8s ease-in-out 4; animation-fill-mode:forwards; opacity:1; }
    @keyframes breatheAnim { 0%{transform:scale(1);background:var(--accent)} 50%{transform:scale(1.6);background:var(--accent-2)} 100%{transform:scale(1);background:var(--accent)} }

    .footer{ font-size:0.9rem; margin-top:20px; color:var(--muted); font-style:italic; }

    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:rgba(0,0,0,0.8); color:#fff; padding:8px 12px; border-radius:8px; display:none; z-index:10003;}

    .walk-overlay{ position:fixed; inset:0; background:rgba(12,12,12,0.45); display:none; align-items:center; justify-content:center; z-index:10000; }
    .walk-highlight{ position:absolute; border-radius:12px; box-shadow:0 14px 36px rgba(0,0,0,0.18); pointer-events:none; transition:all .28s ease; }
    .walk-tooltip{ position:fixed; z-index:10002; max-width:86vw; background:var(--card); color:var(--text); padding:12px 14px; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,0.18); text-align:left; font-size:1rem; }
    .walk-controls{ margin-top:10px; display:flex; gap:10px; justify-content:flex-end; }

    @media (max-width:520px){
      button, select{ min-width:44vw; }
      .prompt-box{ padding-bottom:40px; }
      .walk-tooltip{ font-size:0.96rem; }
    }
  </style>
</head>
<body>
  <div class="logo" aria-hidden="true"><img src="logo.png" alt="HealingLensStudio logo"></div>
  <h1>HealingLensStudio Calm</h1>
  <h2>For the Quiet in You üåø</h2>
  <p class="app-description">A gentle digital calm corner ‚Äî with daily prompts, affirmations, and soft practices for your nervous system. Free. Always here. For the quiet in you.</p>
  <p class="onboard" id="onboardHint" aria-hidden="true"></p>

  <div class="controls" role="group" aria-label="Choose mode and category">
    <label><input type="radio" name="mode" value="prompt" checked> Prompts</label>
    <label><input type="radio" name="mode" value="affirmation"> Affirmations</label>
    <select id="category" aria-label="Choose category">
      <option value="mindfulness">üåø Mindfulness</option>
      <option value="movement">‚ú® Movement</option>
      <option value="kindness">üíõ Kindness</option>
      <option value="creativity">üé® Creativity</option>
    </select>
  </div>

  <div class="prompt-box" id="promptBox" aria-live="polite" aria-atomic="true">
    <p id="prompt" class="prompt">‚ú® Loading your calm‚Ä¶</p>
  </div>

  <div class="controls">
    <button id="newBtn">üå∏ New</button>
    <button id="copyBtn" class="secondary">üìã Copy</button>
    <button id="shareBtn">üì§ Share</button>
    <button id="favBtn" class="secondary">‚≠ê Favorite</button>
    <button id="openFavBtn" class="secondary">üìñ View</button>
  </div>

  <div class="favorites-modal" id="favoritesModal" aria-hidden="true">
    <div class="favorites-backdrop" id="favoritesBackdrop"></div>
    <div class="favorites-card" role="dialog" aria-modal="true" aria-labelledby="favTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 id="favTitle" style="margin:0;font-family:'Poppins',sans-serif">Your Favorites</h3>
        <button id="closeFav" class="secondary" aria-label="Close favorites">‚úñ</button>
      </div>
      <div id="favList" style="line-height:1.6"></div>
      <div style="margin-top:10px; text-align:right;">
        <button id="closeFav2" class="secondary">Close</button>
      </div>
    </div>
  </div>

  <h3>Breathe With Me</h3>
  <div class="breathe-circle" id="breatheCircle" aria-hidden="true"></div>
  <div class="controls">
    <button id="startBreath">‚ñ∂ Start</button>
  </div>

  <div class="footer">HealingLensStudio | For the Quiet in You</div>
  <div id="toast" role="status" aria-live="polite"></div>

  <div class="walk-overlay" id="walkOverlay" aria-hidden="true">
    <div class="walk-highlight" id="walkHighlight" aria-hidden="true"></div>
    <div class="walk-tooltip" id="walkTooltip" aria-hidden="true">
      <div id="walkText">Tap New to get your first calm prompt.</div>
      <div class="walk-controls" style="margin-top:8px;">
        <button id="walkPrev" class="secondary" style="display:none">Back</button>
        <button id="walkNext">Next</button>
        <button id="walkClose" class="secondary">Got it</button>
      </div>
    </div>
  </div>

  <script>
  /******************************************************************
   * Robust single-file app
   * - Loads ./prompts.json if present, else uses built-in fallback
   * - Safe event bindings and error handling
   * - Breathing animation robust across browsers
   ******************************************************************/

  // --- Built-in fallback library (used only if prompts.json fails)
  const FALLBACK = {
    prompts: {
      mindfulness: [
        "Pause. Place one hand on your chest. Feel one full breath enter and leave.",
        "Notice one sound around you that feels calming. Stay with it for a moment.",
        "Close your eyes and imagine your favorite place in nature.",
        "Unclench your jaw. Drop your shoulders. Exhale slowly.",
        "Sip water slowly ‚Äî feel it as a reset ritual.",
        "Look outside. Find something still and breathe with it.",
        "Count your breaths up to five, then begin again.",
        "Touch something near you and notice its texture.",
        "Imagine your breath as waves. Let them wash in and out.",
        "Whisper a kind word to yourself as you would to a friend."
      ],
      movement: [
        "Stretch your arms overhead like you‚Äôre greeting the sun.",
        "Roll your shoulders back three times.",
        "Sway gently side to side like tall grass.",
        "Rotate your wrists and ankles, thanking them.",
        "Stand tall. Imagine a string lifting your head.",
        "Shake your hands as if letting go of the day.",
        "Stretch your spine tall, then fold forward gently.",
        "Tap your feet on the floor rhythmically.",
        "Stretch your side body with one arm overhead.",
        "Circle your shoulders slowly like waves."
      ],
      kindness: [
        "Whisper to yourself: 'I am doing enough.'",
        "Forgive yourself for something small today.",
        "Whisper your name with kindness.",
        "Say softly: 'I am allowed to rest without guilt.'",
        "Affirm: 'I am enough exactly as I am.'",
        "Imagine hugging your younger self.",
        "Whisper: 'I am safe to soften.'",
        "Say: 'I belong here, exactly as I am.'",
        "Affirm: 'Rest is medicine.'",
        "Say: 'Love doesn‚Äôt have to be earned.'"
      ],
      creativity: [
        "Write a one-line poem about the sky.",
        "Sketch something near you without judgment.",
        "Write: 'Today I want to remember‚Ä¶'",
        "Imagine a safe place. Describe it.",
        "Doodle for 2 minutes with no rules.",
        "Write one sentence to your future self.",
        "Draw a symbol of how you feel today.",
        "Write: 'The story I am telling myself is‚Ä¶'",
        "Sketch something that makes you smile.",
        "Write a haiku about this moment."
      ]
    },
    affirmations: {
      mindfulness: [
        "I can return to my breath anytime.",
        "This moment is enough.",
        "I am present with what is.",
        "I allow calm to return to my body."
      ],
      movement: [
        "My body deserves gentle movement.",
        "I release tension step by step.",
        "I honor what my body needs."
      ],
      kindness: [
        "I am worthy of love exactly as I am.",
        "Softness is strength.",
        "I speak kindly to myself."
      ],
      creativity: [
        "Expression is healing.",
        "My ideas do not need to be perfect.",
        "I make space for curiosity."
      ]
    }
  };

  // --- app state
  let prompts = {}, affirmations = {};
  let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  const lastPromptByCategory = {};
  let _animRef = null;

  // --- safe helper to show a toast/status
  let toastTimer = null;
  function showToast(msg, ms=1400){
    try {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> t.style.display = 'none', ms);
    } catch (e) { console.log('toast error', e); }
  }

  // --- load remote prompts.json (fallback to FALLBACK if fails)
  async function loadLibrary(){
    try {
      const res = await fetch('./prompts.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const lib = await res.json();
      if (lib && (lib.prompts || lib.affirmations)) {
        prompts = lib.prompts || {};
        affirmations = lib.affirmations || {};
        console.log('prompts.json loaded');
      } else {
        console.warn('prompts.json missing expected keys, using fallback');
        prompts = FALLBACK.prompts;
        affirmations = FALLBACK.affirmations;
      }
    } catch (err) {
      console.warn('Could not load prompts.json, using fallback library. Error:', err);
      prompts = FALLBACK.prompts;
      affirmations = FALLBACK.affirmations;
    } finally {
      // ensure basic structure exists for categories used by UI
      prompts = prompts || FALLBACK.prompts;
      affirmations = affirmations || FALLBACK.affirmations;
      // show one prompt immediately
      try { newPrompt(); } catch (e) { console.error('newPrompt error', e); }
    }
  }

  // --- prompt UI helpers
  async function setPromptText(text){
    try {
      const box = document.getElementById('promptBox');
      box.classList.add('fade-out');
      await new Promise(r=>setTimeout(r,260));
      document.getElementById('prompt').innerText = text;
      await new Promise(r=>setTimeout(r,40));
      box.classList.remove('fade-out');
    } catch (e) { console.error('setPromptText error', e); }
  }

  function newPrompt(){
    try {
      const cat = (document.getElementById('category')||{}).value || 'mindfulness';
      const modeEl = document.querySelector('input[name="mode"]:checked');
      const mode = (modeEl && modeEl.value) || 'prompt';
      const set = (mode === 'prompt' ? prompts : affirmations)[cat] || [];
      if (!set.length) {
        setPromptText('No items available for this category.');
        return;
      }
      let idx;
      do { idx = Math.floor(Math.random() * set.length); } while (idx === lastPromptByCategory[cat] && set.length > 1);
      lastPromptByCategory[cat] = idx;
      const text = set[idx] + (mode === 'prompt' ? "\n\nüåø Breathe this in. Try writing one line in your journal." : "");
      setPromptText(text);
    } catch (e) { console.error('newPrompt error', e); setPromptText('Sorry ‚Äî something went wrong.'); }
  }

  // --- copy & share
  async function copyPrompt(){
    try { await navigator.clipboard.writeText(document.getElementById('prompt').innerText); showToast('Copied'); }
    catch (e) { console.warn('copy failed', e); showToast('Copy failed'); }
  }
  async function sharePrompt(){
    try {
      const text = document.getElementById('prompt').innerText.trim();
      if (!text) return showToast('Nothing to share');
      if (navigator.share) {
        await navigator.share({ title: 'HealingLensStudio Calm', text });
        showToast('Shared');
        return;
      }
      await navigator.clipboard.writeText(text);
      showToast('Sharing not supported ‚Äî copied');
    } catch (e) { console.warn('share failed', e); showToast('Could not share'); }
  }

  // --- favorites modal
  function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#96;','=':'&#61;'}[c])); }
  function renderFavorites(){
    try {
      const el = document.getElementById('favList');
      if (!favorites.length) { el.innerHTML = '<p>No favorites yet.</p>'; return; }
      el.innerHTML = favorites.map((f,i)=>`<div style="margin-bottom:12px;white-space:pre-wrap">${escapeHtml(f)}<div style="margin-top:6px"><button data-use="${i}">Use</button> <button data-remove="${i}" class="secondary">Remove</button></div></div>`).join('');
      el.querySelectorAll('[data-remove]').forEach(b=>b.addEventListener('click', (ev)=>{ const i=+b.dataset.remove; favorites.splice(i,1); localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavorites(); showToast('Removed'); }));
      el.querySelectorAll('[data-use]').forEach(b=>b.addEventListener('click', ()=>{ const i=+b.dataset.use; setPromptText(favorites[i]); closeFavorites(); showToast('Loaded favorite'); }));
    } catch (e) { console.error('renderFavorites error', e); }
  }
  function openFavorites(){ renderFavorites(); document.getElementById('favoritesModal').style.display = 'flex'; document.getElementById('favoritesModal').setAttribute('aria-hidden','false'); }
  function closeFavorites(){ document.getElementById('favoritesModal').style.display = 'none'; document.getElementById('favoritesModal').setAttribute('aria-hidden','true'); }
  function addFavorite(){ const t = document.getElementById('prompt').innerText; if (!t) return showToast('Nothing to save'); if (!favorites.includes(t)){ favorites.push(t); localStorage.setItem('favorites', JSON.stringify(favorites)); showToast('Saved to favorites'); } else showToast('Already saved'); }

  // --- breathing animation: robust (Web Animations API preferred, else CSS fallback)
  function startBreathing(){
    try {
      const circle = document.getElementById('breatheCircle');
      if (!circle) return;
      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) { showToast('Reduced motion'); return; }

      // show and bring into view
      circle.style.display = 'block';
      circle.style.opacity = '1';
      setTimeout(()=>{ try { circle.scrollIntoView({ behavior:'smooth', block:'center' }); } catch(e){} }, 40);

      // cancel previous
      if (window._hl_breathAnim) { try { window._hl_breathAnim.cancel(); } catch(e){} window._hl_breathAnim = null; }
      circle.classList.remove('breathing');

      const keyframes = [
        { transform: 'scale(1)', background: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#EED9D0' },
        { transform: 'scale(1.6)', background: getComputedStyle(document.documentElement).getPropertyValue('--accent-2') || '#D5E0D5' },
        { transform: 'scale(1)', background: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#EED9D0' }
      ];
      const opts = { duration: 8000, iterations: 4, easing: 'ease-in-out', fill: 'forwards' };

      if (Element.prototype.animate) {
        try {
          window._hl_breathAnim = circle.animate(keyframes, opts);
          circle.classList.add('breathing');
          showToast('ü´Å Follow the circle to breathe');
          window._hl_breathAnim.onfinish = ()=> {
            circle.classList.remove('breathing');
            circle.style.opacity = '0';
            setTimeout(()=> { circle.style.display = 'none'; }, 220);
            window._hl_breathAnim = null;
            showToast('Breathing complete');
          };
          return;
        } catch (e) {
          console.warn('animate error, falling back to CSS', e);
        }
      }

      // CSS fallback
      circle.classList.add('breathing');
      showToast('ü´Å Follow the circle to breathe');
      const total = opts.duration * opts.iterations;
      setTimeout(()=> {
        circle.classList.remove('breathing');
        circle.style.opacity = '0';
        setTimeout(()=> { circle.style.display = 'none'; }, 220);
        showToast('Breathing complete');
      }, total + 50);

    } catch (e) { console.error('startBreathing error', e); showToast('Breathing failed'); }
  }

  // --- walkthrough overlay with auto-scroll
  const walkthroughSteps = [
    { sel:'#newBtn', text:'Tap üå∏ New to get a calming prompt.' },
    { sel:'#shareBtn', text:'Tap üì§ Share to send your prompt.' },
    { sel:'#startBreath', text:'Tap ‚ñ∂ Start to follow the breathing circle.' }
  ];
  function startWalkthrough(index){
    try {
      const overlay = document.getElementById('walkOverlay');
      const hl = document.getElementById('walkHighlight');
      const tip = document.getElementById('walkTooltip');
      const step = walkthroughSteps[index];
      if (!step) { overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); return; }

      document.body.style.overflow = 'hidden';
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden','false');

      const target = document.querySelector(step.sel);
      if (!target) {
        hl.style.width = '0px'; hl.style.height = '0px';
        tip.style.left = '50%'; tip.style.top = '50%';
        document.getElementById('walkText').innerText = step.text;
        document.getElementById('walkPrev').style.display = index>0 ? 'inline-block' : 'none';
        document.getElementById('walkNext').style.display = index < walkthroughSteps.length-1 ? 'inline-block' : 'none';
        document.getElementById('walkNext').onclick = ()=> startWalkthrough(index+1);
        document.getElementById('walkPrev').onclick = ()=> startWalkthrough(index-1);
        document.getElementById('walkClose').onclick = ()=> { overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; localStorage.setItem('hl_walk_v1','1'); };
        return;
      }

      target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
      const WAIT_MS = 380;
      setTimeout(() => {
        const rect = target.getBoundingClientRect();
        const pad = 12;
        hl.style.width = (rect.width + pad*2) + 'px';
        hl.style.height = (rect.height + pad*2) + 'px';
        hl.style.left = (window.scrollX + rect.left - pad) + 'px';
        hl.style.top  = (window.scrollY + rect.top - pad) + 'px';

        const spaceBelow = window.innerHeight - (rect.bottom);
        if (spaceBelow > 160) tip.style.top = (window.scrollY + rect.bottom + 12) + 'px';
        else tip.style.top = Math.max(12, (window.scrollY + rect.top - 130)) + 'px';

        tip.style.left = '50%';
        tip.style.transform = 'translateX(-50%)';
        document.getElementById('walkText').innerText = step.text;
        document.getElementById('walkPrev').style.display = index>0 ? 'inline-block' : 'none';
        document.getElementById('walkNext').style.display = index < walkthroughSteps.length-1 ? 'inline-block' : 'none';
        document.getElementById('walkNext').onclick = ()=> startWalkthrough(index+1);
        document.getElementById('walkPrev').onclick = ()=> startWalkthrough(index-1);
        document.getElementById('walkClose').onclick = ()=> { overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; localStorage.setItem('hl_walk_v1','1'); };
      }, WAIT_MS);
    } catch (e) { console.error('walkthrough error', e); }
  }
  function startWalkthroughIfNeeded(){ if (!localStorage.getItem('hl_walk_v1')) startWalkthrough(0); }

  // --- event bindings (defensive)
  window.addEventListener('load', ()=>{
    try {
      // wire UI
      document.getElementById('newBtn').addEventListener('click', newPrompt);
      document.getElementById('copyBtn').addEventListener('click', copyPrompt);
      document.getElementById('shareBtn').addEventListener('click', sharePrompt);
      document.getElementById('favBtn').addEventListener('click', addFavorite);
      document.getElementById('openFavBtn').addEventListener('click', openFavorites);
      document.getElementById('closeFav').addEventListener('click', closeFavorites);
      document.getElementById('closeFav2').addEventListener('click', closeFavorites);
      document.getElementById('favoritesBackdrop').addEventListener('click', closeFavorites);
      document.getElementById('startBreath').addEventListener('click', startBreathing);
      document.getElementById('category').addEventListener('change', newPrompt);
      document.querySelectorAll('input[name="mode"]').forEach(r=> r.addEventListener('change', newPrompt));

      // start
      loadLibrary();
      showOnboardIfNeeded();
      startWalkthroughIfNeeded();
    } catch (e) { console.error('init error', e); }
  });

  // --- onboarding hint (one-time)
  function showOnboardIfNeeded(){
    try {
      const seen = localStorage.getItem('hl_onboard_v1');
      const el = document.getElementById('onboardHint');
      if (!seen){ el.innerText = "Pick a category and tap üå∏ New to begin. Switch to Affirmations for gentle reminders."; el.style.display='block'; setTimeout(()=>{ el.style.display='none'; localStorage.setItem('hl_onboard_v1','1'); },9000); }
    } catch (e) { /* ignore */ }
  }

  // expose for debugging
  window.healingLens = { newPrompt, addFavorite, openFavorites, loadLibrary, startBreathing: startBreathing };

  </script>
</body>
</html>
