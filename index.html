<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HealingLensStudio Calm</title>

  <!-- Manifest for PWA support -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="HealingLensStudio Calm">
  <link rel="apple-touch-icon" href="logo.png">

  <style>
    body {
      margin: 0;
      font-family: 'Libre Baskerville', serif;
      background: linear-gradient(135deg, #f5f1ec, #e6f0ec, #fdfcfa);
      color: #2E2E2E;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }

    .logo img {
      width: 120px;
      margin: 15px auto;
      display: block;
    }

    h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    h2 {
      font-family: 'Libre Baskerville', serif;
      font-size: 1rem;
      font-style: italic;
      margin-bottom: 10px;
    }

    .app-description {
      font-family: 'Libre Baskerville', serif;
      font-size: 1rem;
      color: #444;
      max-width: 600px;
      margin: 10px auto 20px auto;
      line-height: 1.6;
    }

    .prompt-box {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      max-width: 600px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      text-align: left;
      white-space: pre-wrap;
    }

    .prompt {
      font-size: 1.1rem;
      line-height: 1.6;
      margin: 0;
    }

    .controls {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-bottom: 10px;
    }

    button, select {
      min-height: 44px;
      margin: 8px;
      padding: 10px 18px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    button {
      background: #EED9D0;
      color: #2E2E2E;
      transition: background 0.3s;
    }

    button:hover, button:focus {
      background: #D5E0D5;
      outline: none;
    }

    .favorites-section {
      max-width: 600px;
      margin: 20px auto;
      text-align: left;
      display: none;
    }

    .favorites-section ul {
      padding-left: 16px;
    }

    /* breathe circle: updated for mobile visibility */
    .breathe-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #EED9D0;
      margin: 18px auto;
      display: none;           /* start hidden */
      opacity: 0;
      box-shadow: 0 12px 30px rgba(0,0,0,0.06);
      transform-origin: center center;
      position: relative;
      z-index: 20;
    }

    @keyframes breathe-fallback {
      0%   { transform: scale(1); background: #EED9D0; }
      50%  { transform: scale(1.6); background: #D5E0D5; }
      100% { transform: scale(1); background: #EED9D0; }
    }

    .breathe-visible-fallback {
      display: block !important;
      opacity: 1 !important;
      animation: breathe-fallback 6000ms ease-in-out 4 forwards;
    }

    .footer {
      font-size: 0.8rem;
      margin-top: 20px;
      font-style: italic;
    }

    #toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      display: none;
      z-index: 9999;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="logo" aria-hidden="true">
    <picture>
      <source srcset="logo.webp" type="image/webp">
      <img src="logo.png" alt="HealingLensStudio Logo">
    </picture>
  </div>

  <h1>HealingLensStudio Calm</h1>
  <h2>For the Quiet in You üåø</h2>
  <p class="app-description">
    A gentle digital calm corner ‚Äî with daily prompts, affirmations, and soft practices 
    for your nervous system.<br>
    Free. Always here. For the quiet in you.
  </p>

  <div class="controls" role="group" aria-label="Mode and category">
    <label><input type="radio" name="mode" value="prompt" checked> Prompts</label>
    <label><input type="radio" name="mode" value="affirmation"> Affirmations</label>

    <select id="category" aria-label="Choose category">
      <option value="mindfulness">üåø Mindfulness</option>
      <option value="movement">‚ú® Movement</option>
      <option value="kindness">üíõ Kindness</option>
      <option value="creativity">üé® Creativity</option>
    </select>
  </div>

  <div class="prompt-box" id="promptArea">
    <p id="prompt" class="prompt">‚ú® Loading your calm‚Ä¶</p>
  </div>

  <div class="controls" aria-hidden="false">
    <button id="newBtn">üå∏ New</button>
    <button id="copyBtn">üìã Copy</button>
    <button id="shareBtn">üì§ Share</button>
    <button id="favBtn">‚≠ê Favorite</button>
    <button id="toggleFavBtn">üìñ Favorites</button>
  </div>

  <div class="favorites-section" id="favoritesSection">
    <h3>Your Favorites</h3>
    <ul id="favList"></ul>
    <div style="margin-top:10px;">
      <button id="clearFavBtn">Clear all</button>
      <button id="closeFavBtn">Close</button>
    </div>
  </div>

  <h3>Breathe With Me</h3>
  <div class="breathe-circle" id="breatheCircle" aria-hidden="true"></div>
  <div class="controls">
    <button id="startBreath">‚ñ∂ Start</button>
    <button id="stopBreath">‚ñ† Stop</button>
  </div>

  <div class="footer">HealingLensStudio | For the Quiet in You</div>
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    let prompts = {};
    let affirmations = {};

    async function loadLibrary() {
      try {
        const res = await fetch('./prompts.json', { cache: "no-store" });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const lib = await res.json();
        if (lib && lib.prompts && lib.affirmations) {
          prompts = lib.prompts;
          affirmations = lib.affirmations;
          newPrompt();
          return;
        }
      } catch (e) {
        showToast('Check prompts.json');
      }
    }

    const lastPromptByCategory = {};
    let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

    function newPrompt() {
      const category = document.getElementById("category").value;
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const set = (mode === "prompt" ? prompts : affirmations)[category];

      if (!set || !set.length) {
        document.getElementById("prompt").innerText = "No items available.";
        return;
      }

      let randomIndex;
      do {
        randomIndex = Math.floor(Math.random() * set.length);
      } while (randomIndex === lastPromptByCategory[category] && set.length > 1);
      lastPromptByCategory[category] = randomIndex;

      const text = set[randomIndex];
      document.getElementById("prompt").innerText =
        text + (mode === "prompt" ? "\n\nüåø Breathe this in. Try writing one line in your journal." : "");
    }

    async function copyPrompt() {
      const text = document.getElementById("prompt").innerText;
      try {
        await navigator.clipboard.writeText(text);
        showToast('Copied!');
      } catch {
        showToast('Copy failed');
      }
    }

    async function sharePrompt() {
      const text = document.getElementById("prompt").innerText.trim();
      if (!text) return showToast('Nothing to share');
      if (navigator.share) {
        await navigator.share({ title: 'HealingLensStudio Calm', text });
      } else {
        await navigator.clipboard.writeText(text);
        showToast('Copied to share');
      }
    }

    function addFavorite() {
      const text = document.getElementById("prompt").innerText;
      if (!text) return;
      if (!favorites.includes(text)) {
        favorites.push(text);
        localStorage.setItem("favorites", JSON.stringify(favorites));
        showToast('‚≠ê Saved!');
      } else {
        showToast('Already saved');
      }
    }

    function renderFavorites() {
      const section = document.getElementById('favoritesSection');
      const list = document.getElementById('favList');
      if (!favorites.length) {
        list.innerHTML = '<li>No favorites yet.</li>';
      } else {
        list.innerHTML = favorites.map((f,i)=>
          `<li style="margin-bottom:8px;white-space:pre-wrap;">
            ${f}<br>
            <button onclick="useFavorite(${i})">Use</button>
            <button onclick="removeFavorite(${i})">Remove</button>
          </li>`).join('');
      }
    }

    function useFavorite(i) {
      document.getElementById('prompt').innerText = favorites[i];
      showToast('Loaded favorite');
    }

    function removeFavorite(i) {
      favorites.splice(i,1);
      localStorage.setItem("favorites", JSON.stringify(favorites));
      renderFavorites();
    }

    function clearFavorites() {
      favorites = [];
      localStorage.setItem("favorites", "[]");
      renderFavorites();
      showToast('Cleared');
    }

    // Breathing functions
    let _breathAnim = null;
    let _fallbackTimer = null;

    function startBreathing() {
      const el = document.getElementById('breatheCircle');
      if (!el) return;

      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        showToast('Reduced motion enabled');
        return;
      }

      el.style.display = 'block';
      el.style.opacity = '1';
      el.style.zIndex = 9999;

      if (_breathAnim && typeof _breathAnim.cancel === 'function') {
        try { _breathAnim.cancel(); } catch(e){}
        _breathAnim = null;
      }
      if (_fallbackTimer) { clearTimeout(_fallbackTimer); _fallbackTimer = null; }
      el.classList.remove('breathe-visible-fallback');

      if (Element.prototype.animate) {
        try {
          _breathAnim = el.animate([
            { transform: 'scale(1)', background: '#EED9D0' },
            { transform: 'scale(1.6)', background: '#D5E0D5' },
            { transform: 'scale(1)', background: '#EED9D0' }
          ], { duration: 6000, iterations: 4, easing: 'ease-in-out', fill: 'forwards' });

          showToast('ü´Å Breathe with the circle');
          _breathAnim.onfinish = ()=> {
            el.style.opacity = '0';
            setTimeout(()=> el.style.display = 'none', 200);
            _breathAnim = null;
            showToast('Complete');
          };
          return;
        } catch (err) {
          console.warn('WAAPI error, fallback');
        }
      }

      // fallback
      el.classList.add('breathe-visible-fallback');
      _fallbackTimer = setTimeout(()=>{
        el.classList.remove('breathe-visible-fallback');
        el.style.opacity = '0';
        setTimeout(()=> el.style.display = 'none', 200);
        _fallbackTimer = null;
      }, 6000*4+100);
    }

    function stopBreathing() {
      const el = document.getElementById('breatheCircle');
      if (!el) return;
      if (_breathAnim && typeof _breathAnim.cancel === 'function') {
        try { _breathAnim.cancel(); } catch(e){}
        _breathAnim = null;
      }
      if (_fallbackTimer) { clearTimeout(_fallbackTimer); _fallbackTimer = null; }
      el.classList.remove('breathe-visible-fallback');
      el.style.opacity = '0';
      setTimeout(()=> el.style.display = 'none', 200);
      showToast('Stopped');
    }

    // Toast
    let toastTimer = null;
    function showToast(msg, ms=1600) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> t.style.display = 'none', ms);
    }

    // Event bindings
    document.getElementById('newBtn').addEventListener('click', newPrompt);
    document.getElementById('copyBtn').addEventListener('click', copyPrompt);
    document.getElementById('shareBtn').addEventListener('click', sharePrompt);
    document.getElementById('favBtn').addEventListener('click', addFavorite);
    document.getElementById('toggleFavBtn').addEventListener('click', ()=>{
      const section = document.getElementById('favoritesSection');
      section.style.display = (section.style.display==='block')?'none':'block';
      renderFavorites();
    });
    document.getElementById('clearFavBtn').addEventListener('click', clearFavorites);
    document.getElementById('closeFavBtn').addEventListener('click', ()=>{
      document.getElementById('favoritesSection').style.display='none';
    });
    document.getElementById('startBreath').addEventListener('click', startBreathing);
    document.getElementById('stopBreath').addEventListener('click', stopBreathing);
    document.getElementById('category').addEventListener('change', newPrompt);
    document.querySelectorAll('input[name="mode"]').forEach(r=> r.addEventListener('change', newPrompt));

    window.onload = ()=> loadLibrary();
  </script>
</body>
</html>
