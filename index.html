<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HealingLensStudio Calm ‚Äî Fixed Breathing</title>

  <style>
    :root{
      --bg-1:#f5f1ec; --bg-2:#e6f0ec; --text:#2E2E2E;
      --card:#fff; --accent:#EED9D0; --accent-2:#D5E0D5;
    }
    html,body{height:100%;margin:0}
    body{
      font-family:'Libre Baskerville',serif;
      background:linear-gradient(135deg,var(--bg-1),var(--bg-2));
      color:var(--text);
      padding:20px; display:flex; flex-direction:column; align-items:center; text-align:center;
    }
    h1{ font-family:'Poppins',sans-serif; margin:8px 0; font-size:1.6rem; }
    .prompt-box{ background:var(--card); border-radius:12px; padding:18px; width:100%; max-width:700px; box-shadow:0 8px 20px rgba(0,0,0,0.06); margin:12px 0; text-align:left; white-space:pre-wrap;}
    .prompt{ font-size:1.15rem; line-height:1.6; margin:0; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:10px 0; }
    button{ background:var(--accent); border:none; border-radius:10px; padding:10px 14px; font-family:'Poppins',sans-serif; cursor:pointer; }
    button.secondary{ background:transparent; border:1px solid rgba(0,0,0,0.06); }
    select{ padding:8px 12px; border-radius:8px; }

    /* breathing circle styles */
    .breathe-wrap { margin:18px 0; text-align:center; }
    .breathe-circle {
      width:120px; height:120px; border-radius:50%;
      background:var(--accent); margin:12px auto;
      display:none; opacity:0; transform-origin:center center;
      box-shadow:0 12px 30px rgba(0,0,0,0.06);
    }

    /* CSS fallback animation (same timing as JS) */
    @keyframes breathe-css {
      0% { transform: scale(1); background:var(--accent); }
      50% { transform: scale(1.6); background:var(--accent-2); }
      100% { transform: scale(1); background:var(--accent); }
    }
    .breathe-css {
      animation: breathe-css 6000ms ease-in-out 4 forwards;
      opacity:1 !important;
    }

    #toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:rgba(0,0,0,0.8); color:#fff; padding:8px 12px; border-radius:8px; display:none; z-index:9999; }

    @media (max-width:600px){
      .breathe-circle{ width:100px; height:100px; }
      .prompt{ font-size:1rem; }
    }
  </style>
</head>
<body>
  <h1>HealingLensStudio Calm</h1>

  <div class="controls">
    <label><input type="radio" name="mode" value="prompt" checked> Prompts</label>
    <label><input type="radio" name="mode" value="affirmation"> Affirmations</label>
    <select id="category" aria-label="Category">
      <option value="mindfulness">üåø Mindfulness</option>
      <option value="movement">‚ú® Movement</option>
      <option value="kindness">üíõ Kindness</option>
      <option value="creativity">üé® Creativity</option>
    </select>
  </div>

  <div class="prompt-box">
    <p id="prompt" class="prompt">‚ú® Loading your calm‚Ä¶</p>
  </div>

  <div class="controls">
    <button id="newBtn">üå∏ New</button>
    <button id="copyBtn" class="secondary">üìã Copy</button>
    <button id="shareBtn">üì§ Share</button>
    <button id="favBtn" class="secondary">‚≠ê Favorite</button>
    <button id="toggleFavBtn" class="secondary">üìö Favorites</button>
  </div>

  <!-- Collapsible favorites -->
  <div id="favSection" style="display:none; width:100%; max-width:700px; margin-top:10px; text-align:left;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong>Favorites</strong>
      <div style="display:flex;gap:8px;">
        <button id="clearFav" class="secondary">Clear all</button>
        <button id="closeFav" class="secondary">Close</button>
      </div>
    </div>
    <div id="favList" style="margin-top:10px; background:#fff; padding:12px; border-radius:8px; box-shadow:0 8px 18px rgba(0,0,0,0.06);"></div>
  </div>

  <h3>Breathe With Me</h3>
  <div class="breathe-wrap">
    <div id="breatheCircle" class="breathe-circle" aria-hidden="true"></div>
    <div style="display:flex;gap:8px; justify-content:center; margin-top:8px;">
      <button id="startBtn">‚ñ∂ Start</button>
      <button id="stopBtn" class="secondary">‚ñ† Stop</button>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    /*************************
     * Minimal app (fixed breathing)
     *************************/

    // Tiny inline library (shortened for clarity here; copy/paste your full library back if you want)
    const LIB = {
      prompts: {
        mindfulness: [
          "Pause. Place one hand on your chest. Feel one full breath enter and leave.",
          "Notice one sound around you that feels calming. Stay with it for one minute.",
          "Close your eyes and imagine your favorite place in nature for 30 seconds."
        ],
        movement: ["Stretch your arms overhead like you‚Äôre greeting the sun.","Roll your shoulders back three times.","Sway gently side to side."],
        kindness: ["Whisper to yourself: 'I am doing enough.'","Forgive yourself for something small today.","Whisper your name with kindness."],
        creativity: ["Write a one-line poem about the sky.","Sketch something near you without judgment.","Write: 'Today I want to remember‚Ä¶'"]
      },
      affirmations: {
        mindfulness: ["I can return to my breath anytime.","This moment is enough.","I am present with what is."],
        movement: ["My body deserves gentle movement.","I release tension step by step.","I honor my body's needs."],
        kindness: ["I am worthy of love exactly as I am.","Softness is strength.","I speak kindly to myself."],
        creativity: ["Expression is healing.","My ideas do not need to be perfect.","I make space for curiosity."]
      }
    };

    // State
    let prompts = LIB.prompts;
    let affirmations = LIB.affirmations;
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    const last = {};
    let breathAnim = null;
    let breathTimeout = null;
    let toastTimer = null;

    // Toast helper
    function showToast(msg, ms=1400){
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> t.style.display = 'none', ms);
    }

    // Prompt functions
    function setPrompt(text){ document.getElementById('prompt').innerText = text; }
    function newPrompt(){
      const cat = document.getElementById('category').value;
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const set = (mode === 'prompt' ? prompts : affirmations)[cat] || [];
      if (!set.length) { setPrompt('No items for this category.'); return; }
      let idx; do { idx = Math.floor(Math.random()*set.length); } while (idx === last[cat] && set.length>1);
      last[cat] = idx;
      const text = set[idx] + (mode === 'prompt' ? "\n\nüåø Breathe this in." : "");
      setPrompt(text);
    }

    // Favorite functions
    function saveFavorite(){
      const t = document.getElementById('prompt').innerText;
      if (!t) { showToast('Nothing to save'); return; }
      if (!favorites.includes(t)){ favorites.push(t); localStorage.setItem('favorites', JSON.stringify(favorites)); showToast('Saved'); renderFavs(); }
      else showToast('Already saved');
    }
    function renderFavs(){
      const list = document.getElementById('favList');
      if (!favorites.length){ list.innerHTML = '<div>No favorites yet.</div>'; return; }
      list.innerHTML = favorites.map((f,i)=>`
        <div style="margin-bottom:10px;">
          <div style="white-space:pre-wrap;">${escapeHtml(f)}</div>
          <div style="margin-top:6px; display:flex; gap:8px;">
            <button data-use="${i}" class="secondary">Use</button>
            <button data-remove="${i}" class="secondary">Remove</button>
          </div>
        </div>
      `).join('');
      // wire
      list.querySelectorAll('[data-use]').forEach(b=>b.addEventListener('click', ()=>{ setPrompt(favorites[+b.dataset.use]); showToast('Loaded'); }));
      list.querySelectorAll('[data-remove]').forEach(b=>b.addEventListener('click', ()=>{ favorites.splice(+b.dataset.remove,1); localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavs(); showToast('Removed'); }));
    }
    function toggleFavSection(){
      const sec = document.getElementById('favSection');
      if (sec.style.display === 'none' || !sec.style.display){ renderFavs(); sec.style.display = 'block'; } else sec.style.display = 'none';
    }
    function clearFavorites(){
      if (!favorites.length) return showToast('No favorites');
      if (!confirm('Clear all favorites?')) return;
      favorites = []; localStorage.setItem('favorites', JSON.stringify(favorites)); renderFavs(); showToast('Cleared');
    }

    // Escape helper
    function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#96;','=':'&#61;'}[c])); }

    // Copy + Share
    async function copyPrompt(){
      try { await navigator.clipboard.writeText(document.getElementById('prompt').innerText); showToast('Copied'); }
      catch(e){ showToast('Copy failed'); }
    }
    async function sharePrompt(){
      const text = document.getElementById('prompt').innerText.trim(); if (!text) return showToast('Nothing');
      if (navigator.share){ try{ await navigator.share({title:'HealingLensStudio Calm', text}); showToast('Shared'); return; } catch(e){} }
      try { await navigator.clipboard.writeText(text); showToast('Copied (no share)'); } catch { showToast('Could not share'); }
    }

    // --------------- BREATHING (robust) -----------------
    // Try Web Animations API first; else CSS fallback.
    function startBreathing(){
      const el = document.getElementById('breatheCircle');
      if (!el) return;
      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) { showToast('Reduced motion'); return; }

      // Ensure visible
      el.style.display = 'block';
      el.style.opacity = '1';
      // Cancel any existing
      if (breathAnim && typeof breathAnim.cancel === 'function'){ try { breathAnim.cancel(); } catch {} }
      if (breathTimeout) { clearTimeout(breathTimeout); breathTimeout = null; }

      // Use Web Animations API if available
      if (el.animate) {
        const keyframes = [
          { transform: 'scale(1)', background: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#EED9D0' },
          { transform: 'scale(1.6)', background: getComputedStyle(document.documentElement).getPropertyValue('--accent-2') || '#D5E0D5' },
          { transform: 'scale(1)', background: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#EED9D0' }
        ];
        const opts = { duration: 6000, iterations: 4, easing: 'ease-in-out', fill: 'forwards' };
        try {
          breathAnim = el.animate(keyframes, opts);
          showToast('ü´Å Follow the circle to breathe');
          breathAnim.onfinish = () => {
            // hide after small delay so final frame visible
            setTimeout(()=>{ el.style.opacity = '0'; setTimeout(()=> el.style.display = 'none', 200); showToast('Breathing complete'); }, 80);
            breathAnim = null;
          };
          return;
        } catch (err) {
          console.warn('WAAPI animate failed, falling back to CSS', err);
        }
      }

      // CSS fallback (add class that has CSS animation)
      el.classList.remove('breathe-css');
      void el.offsetWidth; // reflow
      el.classList.add('breathe-css');
      showToast('ü´Å Follow the circle to breathe');
      // remove class after total duration
      breathTimeout = setTimeout(()=>{
        el.classList.remove('breathe-css');
        el.style.opacity = '0';
        setTimeout(()=> el.style.display = 'none', 200);
        showToast('Breathing complete');
        breathTimeout = null;
      }, 6000 * 4 + 60);
    }

    // Stop breathing
    function stopBreathing(){
      const el = document.getElementById('breatheCircle');
      if (!el) return;
      // cancel WAAPI
      if (breathAnim && typeof breathAnim.cancel === 'function') { try { breathAnim.cancel(); } catch {} breathAnim = null; }
      // clear CSS fallback timer
      if (breathTimeout) { clearTimeout(breathTimeout); breathTimeout = null; }
      // remove classes and hide
      el.classList.remove('breathe-css');
      el.style.opacity = '0';
      setTimeout(()=>{ el.style.display = 'none'; }, 160);
      showToast('Stopped');
    }

    // ----------------- Wiring --------------------
    window.addEventListener('load', ()=> {
      document.getElementById('newBtn').addEventListener('click', newPrompt);
      document.getElementById('copyBtn').addEventListener('click', copyPrompt);
      document.getElementById('shareBtn').addEventListener('click', sharePrompt);
      document.getElementById('favBtn').addEventListener('click', saveFavorite);
      document.getElementById('toggleFavBtn').addEventListener('click', toggleFavSection);
      document.getElementById('startBtn').addEventListener('click', startBreathing);
      document.getElementById('stopBtn').addEventListener('click', stopBreathing);
      document.getElementById('clearFav').addEventListener('click', clearFavorites);
      document.getElementById('closeFav').addEventListener('click', toggleFavSection);
      document.getElementById('category').addEventListener('change', newPrompt);
      document.querySelectorAll('input[name="mode"]').forEach(r=> r.addEventListener('change', newPrompt));

      // initial render
      newPrompt();
    });

    // Expose small API for console debugging
    window.healingLens = { startBreathing, stopBreathing, newPrompt, saveFavorite, renderFavs };
  </script>
</body>
</html>
